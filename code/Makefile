# Makefile
.PHONY: init plan apply destroy build-function build-container deploy-k8s clean

# Variables
PROJECT_ID := $(shell gcloud config get-value project)
REGION := europe-west1
FUNCTION_NAME := metadata-processor
CONTAINER_NAME := image-processor

init:
	@echo "ğŸš€ Initializing Terraform..."
	terraform init

plan:
	@echo "ğŸ“‹ Planning Terraform changes..."
	terraform plan -var="project_id=$(PROJECT_ID)" -var="region=$(REGION)"

apply:
	@echo "ğŸ”¨ Applying Terraform changes..."
	terraform apply -var="project_id=$(PROJECT_ID)" -var="region=$(REGION)" -auto-approve

destroy:
	@echo "ğŸ—‘ï¸ Destroying infrastructure..."
	terraform destroy -var="project_id=$(PROJECT_ID)" -var="region=$(REGION)" -auto-approve

build-function:
	@echo "ğŸ“¦ Building Cloud Function..."
	cd function-source && \
	zip -r ../build/function-source.zip . && \
	echo "Function source built at build/function-source.zip"

build-container:
	@echo "ğŸ³ Building Cloud Run container..."
	docker build -t gcr.io/$(PROJECT_ID)/$(CONTAINER_NAME):latest ./container
	docker push gcr.io/$(PROJECT_ID)/$(CONTAINER_NAME):latest

deploy-k8s:
	@echo "â˜¸ï¸ Deploying Kubernetes resources..."
	kubectl apply -f k8s/

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/*
	docker system prune -f

verify:
	@echo "ğŸ” Verifying deployments..."
	@echo "Checking Cloud Run service..."
	gcloud run services describe $(CONTAINER_NAME) --region=$(REGION)
	@echo "Checking Cloud Function..."
	gcloud functions describe $(FUNCTION_NAME) --region=$(REGION)
	@echo "Checking GKE deployments..."
	kubectl get pods

logs:
	@echo "ğŸ“Š Fetching logs..."
	@echo "Cloud Run logs:"
	gcloud logging read "resource.type=cloud_run_revision" --limit=10
	@echo "Cloud Function logs:"
	gcloud logging read "resource.type=cloud_function" --limit=10